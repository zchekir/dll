using System;
using System.IO;
using ActiveUp.Net.Mail;
using NUnit.Framework;
using System.Reflection;

namespace ActiveUp.Net.Tests.Common
{
    [TestFixture]
    public class ParserTests
    {
        private static string _baseDir = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location);

        [Test]
        public void should_parse_simple_date()
        {
            var utcDate = Parser.ParseAsUniversalDateTime("Mon, 24 Jun 2013 10:37:36 +0100");

            utcDate.ShouldEqual(new DateTime(2013, 06, 24, 09, 37, 36));
        }

        [Test]
        public void should_clean_input()
        {
            var utcDate = Parser.ParseAsUniversalDateTime("(noise\\input)Mon, 24 Jun 2013 10:37:36 +0100");

            utcDate.ShouldEqual(new DateTime(2013, 06, 24, 09, 37, 36));
        }

        [Test]
        public void should_return_resulting_date_in_utc()
        {
            var utcDate = Parser.ParseAsUniversalDateTime("Mon, 24 Jun 2013 10:37:36 +0100");

            utcDate.Kind.ShouldEqual(DateTimeKind.Utc);
        }

        [Test]
        public void should_parse_date_with_no_day_of_week()
        {
            var utcDate = Parser.ParseAsUniversalDateTime("24 Jun 2013 10:37:36 +0100");

            utcDate.ShouldEqual(new DateTime(2013, 06, 24, 09, 37, 36));
        }

        [Test]
        public void should_parse_date_with_two_digits_year()
        {
            var utcDate = Parser.ParseAsUniversalDateTime("Mon, 24 Jun 13 10:37:36 +0100");

            utcDate.ShouldEqual(new DateTime(2013, 06, 24, 09, 37, 36));
        }

        [Test]
        public void should_parse_date_with_no_seconds()
        {
            var utcDate = Parser.ParseAsUniversalDateTime("Mon, 24 Jun 2013 10:37 +0100");

            utcDate.ShouldEqual(new DateTime(2013, 06, 24, 09, 37, 00));
        }

        [Test]
        public void should_parse_basic_address()
        {
            var address = Parser.ParseAddress("here@there.com");
            address.Email.ShouldEqual("here@there.com");
            address.Name.ShouldEqual(string.Empty);
        }

        [Test]
        public void should_parse_quoted_address()
        {
            var address = Parser.ParseAddress("<\"here@there.com\">");
            address.Email.ShouldEqual("here@there.com");
            address.Name.ShouldEqual(string.Empty);
        }

        [Test]
        public void should_parse_address_with_quoted_display_name()
        {
            var address = Parser.ParseAddress("\"Display Name\" <display@name.de>");
            address.Email.ShouldEqual("display@name.de");
            address.Name.ShouldEqual("Display Name");
        }

        [Test]
        public void should_parse_address_with_non_quoted_display_name()
        {
            var address = Parser.ParseAddress("DisplayName <display@name.de>");
            address.Email.ShouldEqual("display@name.de");
            address.Name.ShouldEqual("DisplayName");
        }

        [Test]
        public void should_parse_address_with_chevrons_in_display_name()
        {
            var address = Parser.ParseAddress("\"Display Name <with Chevrons>\" <Chevrons@displayname.de>");
            address.Email.ShouldEqual("Chevrons@displayname.de");
            address.Name.ShouldEqual("Display Name <with Chevrons>");
        }

        [Test]
        public void should_parse_address_with_no_closing_quote_after_display_name()
        {
            var address = Parser.ParseAddress("\"Display Name only one quote <Chevrons@displayname.de>");
            address.Email.ShouldEqual("Chevrons@displayname.de");
            address.Name.ShouldEqual("Display Name only one quote");
        }

        [Test]
        public void should_parse_address_with_invalid_empty_quote()
        {
            var address = Parser.ParseAddress("\"\" Invoice@dymak.nl\"");
            address.Email.ShouldEqual("Invoice@dymak.nl");
            address.Name.ShouldEqual("");
        }

        /// <summary>
        /// [discussion:641270] - Created discussion to validate if this test is rigth.
        /// </summary>
        [Test]
        public void should_append_text_parts_with_inline_disposition()
        {
            var message = Parser.ParseMessageFromFile(_baseDir + "\\resource\\text_multipart_email.eml");

            message.BodyText.Text.ShouldEqual("Good morning,\r\nThis is the body of the message.\r\n\r\nThis is the attached disclamer\r\n");
        }

        /// <summary>
        /// [discussion:641270] - Created discussion to validate if this test is rigth.
        /// </summary>
        [Test]
        public void should_append_html_parts_with_inline_disposition()
        {
            var message = Parser.ParseMessageFromFile(_baseDir + "\\resource\\html_multipart_email.eml");

            message.BodyHtml.Text.ShouldEqual("Good morning,\r\n<em>This is the body of the message.</em>\r\n\r\nThis is the <em>attached</em> disclamer\r\n");
        }

        [Test]
        public void should_decode_japanese_content()
        {
            var message = Parser.ParseMessage(File.ReadAllText(_baseDir + "\\resource\\japanese_email.eml"));
            var subject = "Fwd: 大阪瓦斯 (9532) : シェール生産動向、気温が当面の焦点";
            Assert.AreEqual(subject, message.Subject);
            var textBody = "J.P. Morgan Markets Research Email Alerts\r\nhttps://jpmm.com/\r\n\r\nDear Anna-Maria Nilsson,\r\n\r\nJ.P. Morgan Research has published the following on J.P. MorganMarkets.\r\nPlease click on the indicated URL to access your document.\r\n\r\nHeadline:  大阪瓦斯 (9532)  : シェール生産動向、気温が当面の焦点\r\n\r\nAuthor(s):\r\nYuji Nishiyama\r\nhttps://jpmm.com/research/analyst/V577405\r\n\r\n\r\nAbstract:  決算の印象は芳しくなかった：\r\n第2四半期決算を受けて、業績予想を見直した。目標株価を500円から490円に引き下げるが、投資判断「Overweight」を継続する。決算および決算説明会の印象が芳しくなかったことに加え、同業他社による不定期な値下げ実施、ガス制度改革等、当面は向かい風が強く、株価は動意薄とならざるを得ないと考える。ただ、中長期的には海外投資による利益成長と、それに伴う株主還元拡充が期待でき、魅力的な投資対象であるとの見解は維持する。\r\nシェールの生産不調：\r\n決算の印象を悪化させた第1の要因は、米国のピアソール・シェールにおける生産不調に起因する海外エネルギーの通期下方修正。埋蔵量は当初想定通りとのことであり、将来の可能性が減じたわけではないが、短期的には生産が軌道に乗る見通しがまだ立っていない模様であるため、懸念材料として意識されるだろう。\r\nのれん代過多の買収： 第2の要因はJacobi\r\nCarbonsののれん代で、決算説明会では2.5億ドルであることが明らかにされた。買収予定金額は3.9億ドルであり、PBRにして2.8倍となる。営業利益対比で見ると、買収金額はその13倍と、類似取引事例などから鑑みて必ずしも割高ではないが、のれん代の規模は当社が想定していたよりも大きく、市場の評価は得にくいだろう。\r\n今週に入り、気温は急速に低下：\r\n第3四半期決算に向けての焦点は、冬場の気温とピアソール・シェールの生産動向となろう。10月の平均気温は平年を1.8度上回り、11月上旬でも0.3度上回っている。ただ、今週に入って気温が急速に低下し、11月11日の平均気温は12.4度と平年を2度も下回っており、低気温が持続すればガス事業の上振れが期待できる。\r\n\r\nLink:  https://jpmm.com/research/content/GPS-1258467-0\r\n\r\n\r\nDate:  Wed Nov 13 01:15:14 EST 2013\r\n\r\n------------------------------------------------------------------------------------\r\n\r\nVisit J.P. Morgan Markets at https://jpmm.com/research/disclosures\r\n\r\nIf you wish to change your J.P. Morgan Email Alert preferences or\r\nunsubscribe, visit:\r\nhttps://jpmm.com/research/page/cfp_my_alerts\r\n------------------------------------------------------------------------------------\r\n\r\nCopyright @ 1999, 2013 JPMorgan Chase & Co. All Rights Reserved.\r\n\r\nThis email alert is sent only to authorized J.P. Morgan clients and is for\r\ninformational purposes only. This email alert may contain hyperlinks and/or\r\nattachments to J.P. Morgan research that you requested. Additional\r\ninformation available upon request.\r\n\r\nThis email alert may not be forwarded or distributed to any other person\r\nand may not be reproduced in any manner whatsoever. It is not intended as\r\nan offer or solicitation for the purchase or sale of any financial\r\ninstrument or as an official confirmation of any transaction. Access to the\r\nresearch described herein is made available only to authorized J.P. Morgan\r\nclients with a valid ID and password to the J.P Morgan Markets website. The\r\nresearch referred to in this email alert is made available globally by J.P.\r\nMorgan Securities LLC, J.P. Morgan Futures Inc., J.P. Morgan Securities\r\nplc, J.P. Morgan plc, J.P. Morgan Europe Limited or their affiliates as\r\ndesignated via the J.P. Morgan Markets website. All market prices, data and\r\nother information are not warranted as to completeness or accuracy and are\r\nsubject to change without notice. Any comments or statements made herein do\r\nnot necessarily reflect those of JPMorgan Chase & Co., its subsidiaries and\r\naffiliates.\r\n\r\nJ.P. Morgan's Full Disclaimer:  https://jpmm.com/research/disclosures\r\n\n-- \n----------------------------------------------------------------------------------------------------\n*ABC arbitrage, partenaire officiel du skipper Jean-Pierre Dick // ABC \narbitrage, official partner of skipper Jean-Pierre Dick // www.jpdick.com \n<http://www.jpdick.com>*\nPlease consider your environmental responsibility before printing this email\n*********************************************************************************\nCe message peut contenir des informations confidentielles. Les idees et \nopinions presentees dans ce message sont celles de son auteur, et ne \nrepresentent pas necessairement celles du groupe ABC arbitrage.\nAu cas ou il ne vous serait pas destine,merci d'en aviser l'expediteur \nimmediatement et de le supprimer.\n\nThis message may contain confidential information. Any views or opinions \npresented are solely those of its author and do not necessarily represent \nthose of ABC arbitrage. \nIf you are not the intended recipient, please notify the sender immediately \nand delete it.\n*********************************************************************************\n\n";
            Assert.AreEqual(textBody, message.BodyText.Text);
            var htmlBody = "<div dir=\"ltr\"><br><div class=\"gmail_quote\"><br><br>\r\nJ.P. Morgan Markets Research Email Alerts<br>\r\n<a href=\"https://jpmm.com/\" target=\"_blank\">https://jpmm.com/</a><br>\r\n<br>\r\nDear Anna-Maria Nilsson,<br>\r\n<br>\r\nJ.P. Morgan Research has published the following on J.P. MorganMarkets. &nbsp; Please click on the indicated URL to access your document.<br>\r\n<br>\r\nHeadline: &nbsp;大阪瓦斯 (9532) &nbsp;: シェール生産動向、気温が当面の焦点<br>\r\n<br>\r\nAuthor(s):<br>\r\nYuji Nishiyama<br>\r\n<a href=\"https://jpmm.com/research/analyst/V577405\" target=\"_blank\">https://jpmm.com/research/analyst/V577405</a><br>\r\n<br>\r\n<br>\r\nAbstract: &nbsp;決算の印象は芳しくなかった： 第2四半期決算を受けて、業績予想を見直した。目標株価を500円から490円に引き下げるが、投資判断「Overweight」を継続する。決算および決算説明会の印象が芳しくなかったことに加え、同業他社による不定期な値下げ実施、ガス制度改革等、当面は向かい風が強く、株価は動意薄とならざるを得ないと考える。ただ、中長期的には海外投資による利益成長と、それに伴う株主還元拡充が期待でき、魅力的な投資対象であるとの見解は維持する。 シェールの生産不調： 決算の印象を悪化させた第1の要因は、米国のピアソール・シェールにおける生産不調に起因する海外エネルギーの通期下方修正。埋蔵量は当初想定通りとのことであり、将来の可能性が減じたわけではないが、短期的には生産が軌道に乗る見通しがまだ立っていない模様であるため、懸念材料として意識されるだろう。 のれん代過多の買収： 第2の要因はJacobi Carbonsののれん代で、決算説明会では2.5億ドルであることが明らかにされた。買収予定金額は3.9億ドルであり、PBRにして2.8倍となる。営業利益対比で見ると、買収金額はその13倍と、類似取引事例などから鑑みて必ずしも割高ではないが、のれん代の規模は当社が想定していたよりも大きく、市場の評価は得にくいだろう。 今週に入り、気温は急速に低下： 第3四半期決算に向けての焦点は、冬場の気温とピアソール・シェールの生産動向となろう。10月の平均気温は平年を1.8度上回り、11月上旬でも0.3度上回っている。ただ、今週に入って気温が急速に低下し、11月11日の平均気温は12.4度と平年を2度も下回っており、低気温が持続すればガス事業の上振れが期待できる。<br>\r\n\r\n\r\n<br>\r\nLink: &nbsp;<a href=\"https://jpmm.com/research/content/GPS-1258467-0\" target=\"_blank\">https://jpmm.com/research/content/GPS-1258467-0</a><br>\r\n<br>\r\n<br>\r\nDate: &nbsp;Wed Nov 13 01:15:14 EST 2013<br>\r\n<br>\r\n------------------------------------------------------------------------------------<br>\r\n<br>\r\nVisit J.P. Morgan Markets at <a href=\"https://jpmm.com/research/disclosures\" target=\"_blank\">https://jpmm.com/research/disclosures</a><br>\r\n<br>\r\nIf you wish to change your J.P. Morgan Email Alert preferences or unsubscribe, visit:<br>\r\n<a href=\"https://jpmm.com/research/page/cfp_my_alerts\" target=\"_blank\">https://jpmm.com/research/page/cfp_my_alerts</a><br>\r\n------------------------------------------------------------------------------------<br>\r\n<br>\r\nCopyright @ 1999, 2013 JPMorgan Chase &amp; Co. All Rights Reserved.<br>\r\n<br>\r\nThis email alert is sent only to authorized J.P. Morgan clients and is for informational purposes only. This email alert may contain hyperlinks and/or attachments to J.P. Morgan research that you requested. Additional information available upon request.<br>\r\n\r\n\r\n<br>\r\nThis email alert may not be forwarded or distributed to any other person and may not be reproduced in any manner whatsoever. It is not intended as an offer or solicitation for the purchase or sale of any financial instrument or as an official confirmation of any transaction. Access to the research described herein is made available only to authorized J.P. Morgan clients with a valid ID and password to the J.P Morgan Markets website. The research referred to in this email alert is made available globally by J.P. Morgan Securities LLC, J.P. Morgan Futures Inc., J.P. Morgan Securities plc, J.P. Morgan plc, J.P. Morgan Europe Limited or their affiliates as designated via the J.P. Morgan Markets website. All market prices, data and other information are not warranted as to completeness or accuracy and are subject to change without notice. Any comments or statements made herein do not necessarily reflect those of JPMorgan Chase &amp; Co., its subsidiaries and affiliates.<br>\r\n\r\n\r\n<br>\r\nJ.P. Morgan&#39;s Full Disclaimer: &nbsp;<a href=\"https://jpmm.com/research/disclosures\" target=\"_blank\">https://jpmm.com/research/disclosures</a><br>\r\n</div><br></div>\r\n\n<br>\n<div style=\"font-size:1.3em\"><font face=\"Arial, Helvetica, sans-serif\" size=\"2\">------------------------------<WBR>------------------------------<WBR>------------------------------<WBR>----------</font></div><div style=\"font-size:1.3em\"><font face=\"Arial\" size=\"1\"><b><i>ABC arbitrage, partenaire officiel du skipper Jean-Pierre Dick // ABC arbitrage, official partner of skipper Jean-Pierre Dick // <a href=\"http://www.jpdick.com\" target=\"_blank\">www.jpdick.com</a></i></b></font></div><div style=\"font-size:1.3em\"><font face=\"Arial\" color=\"#008000\" size=\"1\">Please consider your environmental responsibility before printing this email</font></div><div style=\"font-size:1.3em\"><font face=\"Arial, Helvetica, sans-serif\" size=\"2\">******************************<WBR>******************************<WBR>*********************</font></div><div><font size=\"1\"><font face=\"Arial, Helvetica, sans-serif\">Ce message peut contenir des informations confidentielles.&nbsp;</font><span style=\"font-family:Arial\">Les idees et opinions presentees dans ce message&nbsp;</span><span style=\"font-family:Arial\">sont celles de son auteur, et ne representent pas necessairement&nbsp;</span><span style=\"font-family:Arial\">celles du groupe ABC arbitrage.</span></font></div><div><font size=\"1\"><font face=\"Arial\">Au cas ou il ne vous serait pas destine,</font><span style=\"font-family:Arial\">merci d&#39;en aviser l&#39;expediteur immediatement et de le supprimer.</span></font></div><div><font face=\"Arial\" size=\"1\"><br></font></div><div><font size=\"1\"><font face=\"Arial\">This message may contain confidential information.&nbsp;</font><span style=\"font-family:Arial\">Any views or opinions presented are solely those of its author&nbsp;</span><span style=\"font-family:Arial\">and do not necessarily represent those of ABC arbitrage.&nbsp;</span></font></div><div><font size=\"1\"><font face=\"Arial\">If you are not the intended recipient,&nbsp;</font><span style=\"font-family:Arial\">please notify the sender immediately and delete it.</span></font></div><div style=\"font-size:1.3em\"><font face=\"Arial, Helvetica, sans-serif\" size=\"2\">******************************<WBR>******************************<WBR>*********************</font></div><div style=\"font-size:1.3em;font-family:Arial,Helvetica,sans-serif\"><br></div>";
            Assert.AreEqual(htmlBody, message.BodyHtml.Text);
            message.Attachments[0].ContentName.ShouldEqual("大阪瓦斯9532.pdf");
        }
        
        /// <summary>
        ///  https://tools.ietf.org/html/rfc2387
        /// </summary>
        [Test(Description = "LineBreak \r or \n only fail.")]
        public void should_recognize_line_break_of_notepad_text_in_body()
        {
            var message = Parser.ParseMessageFromFile(_baseDir + "\\resource\\quoted-printable-notepad-linebreak.eml");
            message.BodyText.Text.ShouldEqual("Sender,\r\rFoi criada uma nova solicitação para TESTE SOLICITANTE.\r\rCliente: TESTE HOTEL\rEmpresa: TESTE\rC. Custo: TESTE TESTE\r\r\r>>> PASSAGEM AÉREA\rDescrição.: (GRU) Cumbica / (LAS) Las Vegas 04/Jan Manhã (06:00 às 12:00) (Econômica)\rHorário...: considerando saída\rPagamento.: FATURADO\r\rDescrição.: (LAS) Las Vegas / (GRU) Cumbica 07/Jan Manhã (06:00 às 12:00) (Econômica)\rHorário...: considerando saída\rPagamento.: FATURADO\r\r\r>>> SOLICITANTE\rteste solicitante (teste-conta@sender.com)\r\r\rDestinatários que estão recebendo esse email: \rtms@server.com (tms@argoit.com.br)\rteste solicitante (teste-conta@sender.com)\rtestereceiver@enterprise.com (testreceiver@enterprise.com)\rtestreceiver@enterprise.co (testreceiver@enterprise.com)\r\rPara acessá-la clique em: \r<https://arb.sender.com/sender/default.aspx?Id=5a03cdaf-1503-e611-9406-90b11c25f027&LinkId=FLXMfbCeRo72PRAkakfyOg%3d%3d> \r\rEMAIL AUTOMÁTICO, NÃO RESPONDA ESSA MENSAGEM\r\n");
            message.BodyHtml.Text.ShouldEqual("");
        }

        /// <summary>
        /// TODO: Change test to fail process correct action in attachment without filename. Actualy the system process.
        /// </summary>
        [Test(Description = "Attachment without filename")]
        public void ParseAttachmentWitoutFilename()
        {
            Message message = Parser.ParseMessageFromFile(_baseDir + "\\resource\\attachment-witout-file-name.eml");
            message.Attachments.Count.ShouldEqual(2);
            for (int i = 0; i < message.Attachments.Count; i++)
                Assert.IsNotNull(message.Attachments[i].Filename);
        }
        /// <summary>
        /// Fields: Confirm-Reading-To, Return-Receipt-To, Disposition-Notification-To was indicated without e-mail address.
        /// RFC3798 has more information about details of parse https://tools.ietf.org/html/rfc3798
        /// NOTE: Without address the system will work with a null return on parse.
        /// </summary>
        [Test(Description = "ConfirmRead, DispositionNotificationTo and ReturnReceiptTo having exception.")]
        public void MustParseInvalidConfirmReadReturnReceipt()
        {
            Message message = Parser.ParseMessageFromFile(_baseDir + "\\resource\\confirm_read_parse_problem.eml");
            Assert.IsNull(message.ConfirmRead);
            Assert.IsNull(message.ReturnReceipt);
            Assert.AreEqual(0, message.Recipients.Count);
        }

        [Test(Description = "")]
        public void MustParseEmlWithWrongImageAsPartOfEmailBody()
        {
            var message = Parser.ParseMessageFromFile(_baseDir + "\\resource\\image-as-body-part.eml");
            Assert.AreEqual("CAM3z=h1WB0qSZPU+PWL5VqxsL1k1gmh0pmJivD1G+LjNC5jTLA@mail.serverhost.com", message.MessageId);
            Assert.AreEqual("Boa tarde roger,\r\n\r\nAgradeço a atenção e atendimento. Pode fechar o pedido com 2 cápsulas no\r\nvalor passado de $123.312.313,04.\r\n\r\nMoro em Abracox, eu busco pessoalmente ou recebo no meu endereço? E qual o\r\nprazo de entrega e formas de pagamento?\r\n\r\nObrigado,\r\nJosé roger\r\n\r\n\r\nEm 23 de julho de 2016 09:00, roger Munes <\r\nroger@destinataryhost.com> escreveu:\r\n\r\n> Com 2 cáp deu $123.312.313,04 fico no seu aguardo para finalizar o pedido..\r\n>\r\n>\r\n> Atenciosamente, roger Mussa\r\n>  [image: Customer Supplier]*roger de Souza Nunes* /\r\n> Atendimento\r\n> roger@destinataryhost.com <%7bEmail%7d>\r\n>\r\n>\r\n> *Customer supplier*\r\n> 0800 116 7284 -  (99) 9376-8104\r\n> http://www.destinataryhost.com\r\n>\r\n>\r\n>\r\n> [image: Twitter] <https://www.twitter.com/customersupplier>  [image:\r\n> Facebook] <https://www.facebook.com/custsupplier>  [image: Instagram]\r\n> <https://www.instagram.com/custsupplier>\r\n> Antes de imprimir este e-mail veja se é necessário e pense em sua\r\n> responsabilidade com o *Meio Ambiente*.\r\n>\r\n>\r\n>\r\n> *De:* rogerneto@serverhost.com\r\n> *Enviada em:* 22/07/2016 19:13:51\r\n> *Para:* roger Munes\r\n> *Assunto:* Re: Re: Contact\r\n> Olá roger, esse valor é com 90 cápsulas, correto? Veja por gentileza com\r\n> 2 aproveito para comprar logo mais.\r\n>\r\n> Obrigado pela atenção.\r\n>\r\n> José roger\r\n>\r\n> Em 22 de julho de 2016 16:05, roger Munes <\r\n> roger@destinataryhost.com> escreveu:\r\n>\r\n> Boa tarde tudo bem ? orçamento 345788 consegui por $ 2.222,00\r\n> fico no seu aguardo.\r\n>\r\n>\r\n> Atenciosamente, roger Mussa\r\n>  [image: Customer Supplier]*roger Munes* /\r\n> Atendimento\r\n> roger@destinataryhost.com <%7bEmail%7d>\r\n>\r\n>\r\n> *Customer supplier*\r\n> 0800 116 7284 -  (99) 9376-8104\r\n> http://www.destinataryhost.com\r\n>\r\n>\r\n>\r\n> [image: Twitter] <https://www.twitter.com/customersupplier>  [image:\r\n> Facebook] <https://www.facebook.com/custsupplier>  [image: Instagram]\r\n> <https://www.instagram.com/custsupplier>\r\n> Antes de imprimir este e-mail veja se é necessário e pense em sua\r\n> responsabilidade com o *Meio Ambiente*.\r\n>\r\n>\r\n>\r\n> *De:* rogerneto@serverhost.com\r\n> *Enviada em:* 22/07/2016 14:55:08\r\n> *Para:* roger Munes\r\n> *Assunto:* Re: Contact\r\n> Boa tarde roger,\r\n>\r\n> Agradeço o contato. Ainda não comprei porém tenho o orçamento abaixo que\r\n> infelizmente está abaixo da Miligrama. Caso consiga cobrir, prefiro comprar\r\n> com vocês por já ser cliente e ter outras compras com sucesso no histórico.\r\n>\r\n>\r\n> Obrigado,\r\n> José roger\r\n>\r\n>\r\n>\r\n> Em 22 de julho de 2016 14:49, roger Munes <\r\n> roger@destinataryhost.com> escreveu:\r\n>\r\n> Boa tarde amigo, como vai ?\r\n>\r\n> Chegou a finalizar o pedido, comprou em outro lugar ? que achou do meu\r\n> orçamento vamos negociar cubro a oferta de qualquer concorrente.\r\n>\r\n>\r\n> Atenciosamente, roger Mussa\r\n>  [image: Customer Supplier]*roger de Souza Nunes* /\r\n> Atendimento\r\n> roger@destinataryhost.com <%7bEmail%7d>\r\n>\r\n>\r\n> *Customer supplier*\r\n> 0800 116 7284 -  (99) 9376-8104\r\n> http://www.destinataryhost.com\r\n>\r\n>\r\n>\r\n> [image: Twitter] <https://www.twitter.com/customersupplier>  [image:\r\n> Facebook] <https://www.facebook.com/custsupplier>  [image: Instagram]\r\n> <https://www.instagram.com/custsupplier>\r\n> Antes de imprimir este e-mail veja se é necessário e pense em sua\r\n> responsabilidade com o *Meio Ambiente*.\r\n>\r\n>\r\n>\r\n>\r\n".Replace("\r\n", ""), message.BodyText.Text.Replace("\r\n", ""));
            Assert.AreEqual("<div dir=\"ltr\">Boa tarde roger,<div><br></div><div>Agradeço a atenção e atendimento. Pode fechar o pedido com 2 cápsulas no valor passado de <span style=\"font-size:12.8px\">$ 2.222,00.</span></div><div><br></div><div>Moro em Cubivila, eu busco pessoalmente ou recebo no meu endereço? E qual o prazo de entrega e formas de pagamento?</div><div><br></div><div>Obrigado,</div><div>José roger</div><div><br></div></div><div class=\"gmail_extra\"><br><div class=\"gmail_quote\">Em 23 de julho de 2016 09:00, roger Munes <span dir=\"ltr\">&lt;<a href=\"mailto:roger@destinataryhost.com\" target=\"_blank\">roger@custsupplier.com..br</a&gt;</span> escreveu:<br><blockquote class=\"gmail_quote\" style=\"margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex\"><div>Com 2 cáp deu $ 2.222,00 fico no seu aguardo para finalizar o pedido.    \r\n<span class=\"\"><div>\r\n<p><br>\r\nAtenciosamente, roger Mussa<br>\r\n <img alt=\"Customer Supplier\" src=\"http://www.customerhost.com/assinatura/logo.png\"><strong>roger de Souza Nunes</strong> / Atendimento<br>\r\n<a href=\"mailto:%7bEmail%7d\" target=\"_blank\">roger@destinataryhost.com</a><br>\r\n<br>\r\n<br>\r\n<strong>Customer supplier</strong> <br>\r\n0800 116 7284 - <img alt=\"\" src=\"http://customerhost.com/assinatura/whatsappm.png\"> (99) 9376-8104<br>\r\n<a href=\"http://www.destinataryhost.com/\" target=\"_blank\">http://www.destinataryhost.com</a>  <br>\r\n<br>\r\n<br>\r\n<br>\r\n<a href=\"https://www.twitter.com/customersupplier\" target=\"_blank\"><img alt=\"Twitter\" src=\"http://www.customerhost.com/assinatura/twitterm.png\"></a>  <a href=\"https://www.facebook.com/custsupplier\" target=\"_blank\"><img alt=\"Facebook\" src=\"http://www.customerhost.com/assinatura/facebookm.png\"></a>  <a href=\"https://www.instagram.com/custsupplier\" target=\"_blank\"><img alt=\"Instagram\" src=\"http://www.customerhost.com/assinatura/instagramm.png\"></a><br>\r\nAntes de imprimir este e-mail veja se é necessário e pense em sua responsabilidade com o <strong>Meio Ambiente</strong>.</p>\r\n\r\n<p><img alt=\"\" src=\"cid:31391411\" style=\"border:0px solid black;min-height:200px;margin-bottom:0px;margin-left:0px;margin-right:0px;margin-top:0px;width:600px\"></p>\r\n\r\n<p> </p>\r\n</div>\r\n \r\n\r\n</span><div style=\"text-align:left\"><strong>De:</strong> <a href=\"mailto:rogerneto@serverhost.com\" target=\"_blank\">rogerneto@serverhost.com</a><br>\r\n<strong>Enviada em:</strong> 22/07/2016 19:13:51<span class=\"\"><br>\r\n<strong>Para:</strong> roger Munes<br>\r\n</span><strong>Assunto:</strong> Re: Re: Contact</div><div><div class=\"h5\">\r\n\r\n<div>Olá roger, esse valor é com 90 cápsulas, correto? Veja por gentileza com 2 aproveito para comprar logo mais.\r\n<div> </div>\r\n\r\n<div>Obrigado pela atenção.</div>\r\n\r\n<div> </div>\r\n\r\n<div>José roger</div>\r\n</div>\r\n\r\n<div> \r\n<div>Em 22 de julho de 2016 16:05, roger Munes &lt;<a href=\"mailto:roger@destinataryhost.com\" target=\"_blank\">roger@destinataryhost.com</a>&gt; escreveu:\r\n\r\n<blockquote>\r\n<div>Boa tarde tudo bem ? orçamento 345788 consegui por $ 2.222,00<br>\r\nfico no seu aguardo.\r\n<div>\r\n<p><br>\r\nAtenciosamente, roger Mussa<br>\r\n <img alt=\"Customer Supplier\" src=\"http://www.customerhost.com/assinatura/logo.png\"><strong>roger de Souza Nunes</strong> / Atendimento<br>\r\n<a href=\"mailto:%7bEmail%7d\" target=\"_blank\">roger@destinataryhost.com</a><br>\r\n<br>\r\n<br>\r\n<strong>Customer supplier</strong> <br>\r\n0800 116 7284 - <img alt=\"\" src=\"http://customerhost.com/assinatura/whatsappm.png\"> (99) 9376-8104<br>\r\n<a href=\"http://www.destinataryhost.com/\" target=\"_blank\">http://www.fmiligrama.com.br</a>  <br>\r\n<br>\r\n<br>\r\n<br>\r\n<a href=\"https://www.twitter.com/customersupplier\" target=\"_blank\"><img alt=\"Twitter\" src=\"http://www.customerhost.com/assinatura/twitterm.png\"></a>  <a href=\"https://www.facebook.com/custsupplier\" target=\"_blank\"><img alt=\"Facebook\" src=\"http://www.customerhost.com/assinatura/facebookm.png\"></a>  <a href=\"https://www.instagram.com/custsupplier\" target=\"_blank\"><img alt=\"Instagram\" src=\"http://www.customerhost.com/assinatura/instagramm.png\"></a><br>\r\nAntes de imprimir este e-mail veja se é necessário e pense em sua responsabilidade com o <strong>Meio Ambiente</strong>.</p>\r\n\r\n<p><img alt=\"\" src=\"cid:16636849\" style=\"border:0px solid black;margin-bottom:0px;margin-left:0px;margin-right:0px;margin-top:0px;min-height:200px;width:600px\"></p>\r\n\r\n<p> </p>\r\n</div>\r\n \r\n\r\n<div style=\"text-align:left\"><strong>De:</strong> <a href=\"mailto:ramalhoneto@serverhost.com\" target=\"_blank\">rogerneto@serverhost.com</a><br>\r\n<strong>Enviada em:</strong> 22/07/2016 14:55:08<br>\r\n<strong>Para:</strong> roger Munes<br>\r\n<strong>Assunto:</strong> Re: Contact</div>\r\n\r\n<div>\r\n<div>\r\n<div>Boa tarde roger,\r\n<div> </div>\r\n\r\n<div>Agradeço o contato. Ainda não comprei porém tenho o orçamento abaixo que infelizmente está abaixo da Miligrama. Caso consiga cobrir, prefiro comprar com vocês por já ser cliente e ter outras compras com sucesso no histórico.</div>\r\n\r\n<div> </div>\r\n\r\n<div> </div>\r\n\r\n<div>Obrigado,</div>\r\n\r\n<div>José roger</div>\r\n\r\n<div> </div>\r\n\r\n<div> </div>\r\n\r\n<div> </div>\r\n\r\n<div>\r\n<div>Em 22 de julho de 2016 14:49, roger Munes &lt;<a href=\"mailto:roger@destinataryhost.com\" target=\"_blank\">roger@destinataryhost.com</a>&gt; escreveu:\r\n\r\n<blockquote>\r\n<div>Boa tarde amigo, como vai ?<br>\r\n<br>\r\nChegou a finalizar o pedido, comprou em outro lugar ? que achou do meu orçamento vamos negociar cubro a oferta de qualquer concorrente.\r\n<div>\r\n<p><br>\r\nAtenciosamente, roger Mussa<br>\r\n <img alt=\"Customer Supplier\" src=\"http://www.customerhost.com/assinatura/logo.png\"><strong>roger de Souza Nunes</strong> / Atendimento<br>\r\n<a href=\"mailto:%7bEmail%7d\" target=\"_blank\">roger@destinataryhost.com</a><br>\r\n<br>\r\n<br>\r\n<strong>Customer supplier</strong> <br>\r\n0800 116 7284 - <img alt=\"\" src=\"http://customerhost.com/assinatura/whatsappm.png\"> (99) 9376-8104<br>\r\n<a href=\"http://www.destinataryhost.com/\" target=\"_blank\">http://www.fmiligrama.com.br</a>  <br>\r\n<br>\r\n<br>\r\n<br>\r\n<a href=\"https://www.twitter.com/customersupplier\" target=\"_blank\"><img alt=\"Twitter\" src=\"http://www.customerhost.com/assinatura/twitterm.png\"></a>  <a href=\"https://www.facebook.com/custsupplier\" target=\"_blank\"><img alt=\"Facebook\" src=\"http://www.customerhost.cor/assinatura/facebookm.png\"></a>  <a href=\"https://www.instagram.com/custsupplier\" target=\"_blank\"><img alt=\"Instagram\" src=\"http://www.customerhost.com/assinatura/instagramm.png\"></a><br>\r\nAntes de imprimir este e-mail veja se é necessário e pense em sua responsabilidade com o <strong>Meio Ambiente</strong>.</p>\r\n\r\n<p><img alt=\"\" src=\"cid:16636849\" style=\"border:0px solid black;margin-bottom:0px;margin-left:0px;margin-right:0px;margin-top:0px;min-height:200px;width:600px\"></p>\r\n\r\n<p> </p>\r\n</div>\r\n</div>\r\n</blockquote>\r\n</div>\r\n</div>\r\n</div>\r\n</div>\r\n</div>\r\n</div>\r\n</blockquote>\r\n</div>\r\n</div>\r\n</div></div></div></blockquote></div><br></div>\r\n".Replace("\r\n", ""), message.BodyHtml.Text.Replace("\r\n", ""));
            Assert.AreEqual("Re: Re: Re: Contact", message.Subject);
            Assert.AreEqual(1, message.To.Count);
            Assert.AreEqual(2, message.EmbeddedObjects.Count);
            Assert.AreEqual(0, message.Attachments.Count);

            // Manual validation: Save the attachment to validate if has valid image.
            //var i = 0;
            //foreach (MimePart item in message.EmbeddedObjects)
            //{
            //    var fileName = item.ContentName ?? "file" + i + ".jpg";
            //    var fileNameDecoded = item.ContentName ?? "file_decoded_" + i + ".jpg";
            //    i++;
            //    File.WriteAllBytes(fileName, item.BinaryContent);
            //    File.WriteAllBytes(fileNameDecoded, Convert.FromBase64String(item.TextContentTransferEncoded));
            //}
        }

        [Test(Description = "")]
        public void MustParseEmlWithoutContentTypeSubtypeWithLostTextBody()
        {
            var message = Parser.ParseMessageFromFile(_baseDir + "\\resource\\text_without_contenttype_subtype.eml");
            Assert.AreEqual("hash@sender.production.server.com", message.MessageId);
            Assert.IsFalse(string.IsNullOrWhiteSpace(message.BodyText.Text));
            Assert.IsTrue(string.IsNullOrWhiteSpace(message.BodyHtml.Text));
            Assert.AreEqual("plain", message.ContentType.SubType);
            Assert.AreEqual("text", message.ContentType.Type);
            Assert.AreEqual("text", message.ContentType.MimeType);
        }

        [Test(Description = "")]
        public void MustParseEmlWithContentTransferEncode8Bit()
        {
            var message = Parser.ParseMessageFromFile(_baseDir + "\\resource\\content-transfer-encode-8bit.eml");
            Assert.AreEqual("58caaa74.6625ed0a.22a2d.5376@mx.google.com", message.MessageId);
            Assert.AreEqual("Special char test  çãõáéíóú", message.Subject);
            Assert.IsFalse(string.IsNullOrWhiteSpace(message.BodyText.Text));
            Assert.AreEqual("Body special char test  çãõáéíóú", message.BodyText.Text);
            Assert.IsTrue(string.IsNullOrWhiteSpace(message.BodyHtml.Text));
        }

        [Test(Description = "")]
        public void MustParseEmlWithContentTransferEncode8BitUtf8FlowedHistory()
        {
            var message = Parser.ParseMessageFromFile(_baseDir + "\\resource\\content-transfer-encode-8bit-utf8-flowed.eml");
            Assert.AreEqual("bd502b4d-c631-9ff4-791f-fc01c9efc0e5@EmpresaX.com.br", message.MessageId);
            Assert.AreEqual("Re: BLA BLÁ BLA XYZ/ XYZ / TROCA DE PACOTES origem ABC Destino XYZ x XYZ Nfs 666666 / 777777 Fornecedor Xamego INDUSTRIA", message.Subject);
            Assert.IsFalse(string.IsNullOrWhiteSpace(message.BodyText.Text));
            var result = message.BodyText.Text;
            var expected = "Boa tarde,\r\n\r\n*Fulano*, conforme o conversado em nosso teste, os dados do erro ja \r\nforam coletados, estamos trabalhando com a máxima urgência afim de \r\nefetuarmos a identificação.\r\n\r\n_Em contato com o cliente estou tentando reproduzir o problema\r\nnesta mensagem._\r\n\r\n_*Ciclano*( Empresa B ), por gentileza, conforme ja conversado, peço, \r\npriorizar acompanhar a estrutura errada deste e-mail._\r\n\r\n\r\nCerta da atenção, agradeço\r\n\r\n\r\n*Reinaldo Coelho *\r\nNosso Grupo\r\n\r\n*\r\nEm 12/04/2017 09:10, Fulano escreveu:\r\n>\r\n> Ok, Agradeço a atenção Ciclano.\r\n>\r\n> *Reinaldo Coelho *\r\n> *Meu cargo atual*\r\n> EmpresaX\r\n> *Fone:(11) 2222-4444 / Ramal: 123 **\r\n> *Email:mary.anne@EmpresaX.com.br \r\n> <mailto:mary.anne@EmpresaX.com.br>*\r\n> *Acesse nosso site:www.EmpresaX.com.br <http://www.EmpresaX.com.br>*\r\n> Nosso Grupo\r\n>\r\n> *\r\n> Em 12/04/2017 09:01, Florencia Ramos Conceição escreveu:\r\n>>\r\n>>\r\n>>\r\n>> Sim volumes pertencido a XYZ já desembarcarão e segue hoje para \r\n>> araguaina-to\r\n>>\r\n>> Duvidas a disposição.\r\n>>\r\n>>\r\n>> -- \r\n>> *Florencia   Ramos Conceição*\r\n>> * Pendencia Fiscal*\r\n>>\r\n>> *Fone:(12)1111-6333*\r\n>> *Email:xyz.pendencias1@EmpresaX.com.br*\r\n>> *Acesse nosso site:www.EmpresaX.com.br <http://www.EmpresaX.com.br>*\r\n>>\r\n>> *----- Original Message ----*\r\n>> *From:* mary.anne@EmpresaX.com.br\r\n>> *To:* \"Florencia Ramos Conceição\" (xyz.pendencias1@EmpresaX.com.br)\r\n>> *Cc:* \"Carlão Steave\" (vendasnonorte@prego.com.br)\r\n>> *Date:* Tue, 11 Apr 2017 15:11:37 -0300\r\n>> *Subject:* Re: BLA BLÁ BLA XYZ/ XYZ / TROCA DE PACOTES origem ABC Destino \r\n>>\r\n>>     Boa tarde,\r\n>>\r\n>>     tentei contato telefônico, porem não foi possível; o cliente que\r\n>>     xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\r\n>>     yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy\r\n>>     informar se o volume do mesmo ja consta em XYZ???\r\n>>\r\n>>     Fico no aguardo para informarmos ao cliente.\r\n>>\r\n>>     Agradeço\r\n>>\r\n>>     att,\r\n>>\r\n>>     *Reinaldo Coelho *\r\n>>     *Meu cargo atual*\r\n>>\r\n>>     *Fone:(11) 2222-4444 / Ramal: 123 **\r\n>>     *Email:mary.anne@EmpresaX.com.br\r\n>>     <mailto:mary.anne@EmpresaX.com.br>*\r\n>>     *Acesse nosso site:www.EmpresaX.com.br\r\n>>     <http://www.EmpresaX.com.br>*\r\n>>\r\n>>\r\n>>     *\r\n>>     Em 05/04/2017 17:03, Florencia Ramos Conceição escreveu:\r\n>>\r\n>>\r\n>>         Esta seguindo os dois\r\n>>\r\n>>\r\n>>         -- \r\n>>         *Florencia   Ramos Conceição*\r\n>>         * Pendencia Fiscal*\r\n>>\r\n>>         *Fone:(12)1111-6333*\r\n>>         *Email:xyz.pendencias1@EmpresaX.com.br*\r\n>>         *Acesse nosso site:www.EmpresaX.com.br\r\n>>         <http://www.EmpresaX.com.br>*\r\n>>\r\n>>         *----- Original Message ----*\r\n>>         *From:* XYZ.pendencia04@EmpresaX.com.br\r\n>>         *To:* \"Florencia Ramos Conceição\"\r\n>>         (xyz.pendencias1@EmpresaX.com.br), \"Fulano\"\r\n>>         (mary.anne@EmpresaX.com.br)\r\n>>         *Date:* Wed, 5 Apr 2017 16:58:34 -0300\r\n>>         *Subject:* Re: BLA BLÁ BLA XYZ/ XYZ / TROCA DE PACOTES origem ABC Destino \r\n>>\r\n>>             Ok, lembrando que trata-se de dois volume de XYZ.\r\n>>\r\n>>             Obrigada.\r\n>>\r\n>>\r\n>>\r\n>>\r\n>>\r\n>>             Em 5/4/2017 16:53, Florencia Ramos Conceição escreveu:\r\n>>\r\n>>                 Volume  pertencido a filial XYZ  esta seguindo\r\n>>                 atraves de RRI-0031800000\r\n>>\r\n>>\r\n>>                 -- \r\n>>                 *Florencia   Ramos Conceição*\r\n>>                 * Pendencia Fiscal*\r\n>>\r\n>>                 *Fone:(12)1111-6333*\r\n>>                 *Email:xyz.pendencias1@EmpresaX.com.br*\r\n>>                 *Acesse nosso site:www.EmpresaX.com.br\r\n>>                 <http://www.EmpresaX.com.br>*\r\n>>\r\n>>                 *----- Original Message ----*\r\n>>                 *From:* XYZ.pendencia04@EmpresaX.com.br\r\n>>                 *To:* \"Fulano\" (mary.anne@EmpresaX.com.br),\r\n>>                 \"Florencia Ramos Conceição\"\r\n>>                 (xyz.pendencias1@EmpresaX.com.br)\r\n>>                 *Date:* Wed, 5 Apr 2017 09:15:54 -0300\r\n>>                 *Subject:* BLA BLÁ BLA XYZ/ XYZ / TROCA DE PACOTES origem ABC Destino \r\n>>\r\n>>                     Bom dia !\r\n>>\r\n>>                     Fulano,\r\n>>\r\n>>\r\n>>                     Essa destroca esta difícil de ser resolvida, pois\r\n>>                     os volumes que se encontravam em XYZ   , foi\r\n>>                     enviado , e até o momento não foi nos enviado os\r\n>>                     nossos corretos . O cliente XYZ nos cobra\r\n>>                     posicionamento , e se que tenho retorno da filial\r\n>>                     XYZ.\r\n>>\r\n>>                     Favor resolver esse caso , o quanto antes.\r\n>>\r\n>>\r\n>>\r\n>>                     Em 5/4/2017 08:48, Fulano escreveu:\r\n>>\r\n>>                         Bom dial,\r\n>>\r\n>>                         Pessoal informaçoes referente a\r\n>>                         destroca??...pXYZiso de um retorno*URGENTE,\r\n>>                         *pois o fornecedor( nossoMONITORADO) tem nos\r\n>>                         cobra regularmente este posicionamento.\r\n>>\r\n>>                         Fico no aguardo, para que possamos\r\n>>                         comunica-lo o mais breve possival\r\n>>\r\n>>                         att,\r\n>>\r\n>>                         *Reinaldo Coelho *\r\n>>                         *Meu cargo atual*\r\n>>\r\n>>                         *Fone:(11) 2222-4444 / Ramal: 123 **\r\n>>                         *Email:mary.anne@EmpresaX.com.br*\r\n>>                         *Acesse nosso site:www.EmpresaX.com.br*\r\n>>\r\n>>\r\n>>                         *\r\n>>                         Em 03/04/2017 09:48, Fulano escreveu:\r\n>>\r\n>>                             Bom dia,\r\n>>\r\n>>                             Ciclano assim que possível posicionar,\r\n>>                             peço também que verifique a XYZusa do\r\n>>                             cliente sobre 3 volumes, pois o erro era\r\n>>                             apenas em 2 volumes, sendo estes para a\r\n>>                             filial de XYZ...\r\n>>\r\n>>                             *Reinaldo Coelho *\r\n>>                             *Meu cargo atual*\r\n>>\r\n>>                             *Fone:(11) 2222-4444 / Ramal: 123 **\r\n>>                             *Email:mary.anne@EmpresaX.com.br*\r\n>>                             *Acesse nosso site:www.EmpresaX.com.br*\r\n>>\r\n>>\r\n>>                             *\r\n>>                             Em 03/04/2017 09:44, Gabriela Xavier escreveu:\r\n>>\r\n>>                                 Bom dia !\r\n>>\r\n>>                                 Temos algum posicionamento ?\r\n>>\r\n>>                                 Nosso cliente nos cobra RETORNO COM\r\n>>                                 URGÊNCIA...\r\n>>\r\n>>\r\n>>                                 Em 31/3/2017 09:35, Fulano escreveu:\r\n>>\r\n>>                                     Bom dia,\r\n>>\r\n>>                                     Ok, agradeço a atenção.\r\n>>\r\n>>                                     *Reinaldo Coelho *\r\n>>                                     *Meu cargo atual*\r\n>>\r\n>>                                     *Fone:(11) 2222-4444 / Ramal: 123 **\r\n>>                                     *Email:mary.anne@EmpresaX.com.br*\r\n>>\r\n>>                                     *Acesse nosso\r\n>>                                     site:www.EmpresaX.com.br*\r\n>>\r\n>>\r\n>>                                     *\r\n>>                                     Em 31/03/2017 09:25, Ciclano\r\n>>                                     Ramos Conceição escreveu:\r\n>>\r\n>>                                         Valéria Bom Dia\r\n>>\r\n>>                                         Trata-se de rota do interior,\r\n>>                                         no qual já foi XYZusado os 03\r\n>>                                         volumes pelo cliente, e\r\n>>                                         parceiro já esta retornando\r\n>>                                         com mercadoria para\r\n>>                                         transportadora para estarmos\r\n>>                                         verificando, assim que tiver\r\n>>                                         ok, informo ID de envio para\r\n>>                                         acompanhamento,\r\n>>\r\n>>                                         Duvidas a disposição.\r\n>>\r\n>>\r\n>>                                         -- \r\n>>                                         *Florencia   Ramos Conceição*\r\n>>                                         * Pendencia Fiscal*\r\n>>\r\n>>                                         *Fone:(12)1111-6333*\r\n>>                                         *Email:xyz.pendencias1@EmpresaX.com.br*\r\n>>\r\n>>                                         *Acesse nosso\r\n>>                                         site:www.EmpresaX.com.br*\r\n>>                                         & amp; lt; /p>\r\n>>\r\n>>                                         *----- Original Message ----*\r\n>>                                         *From:*\r\n>>                                         XYZ.pendencia04@EmpresaX.com.br\r\n>>                                         *To:* \"Fulano\"\r\n>>                                         (mary.anne@EmpresaX.com.br),\r\n>>                                         \"Roque Neto\"\r\n>>                                         (xyz.pendencias1@EmpresaX.com.br)\r\n>>                                         *Date:* Fri, 31 Mar 2017\r\n>>                                         08:56:52 -0300\r\n>>                                         *Subject:* BLA BLÁ BLA XYZ/ \r\n>>\t\t\t\t\t\t\t\t\t\t\tXYZ / TROCA DE PACOTES origem \r\n>>\t\t\t\t\t\t\t\t\t\t\tABC Destino \r\n>>\r\n>>                                             Bom dia !\r\n>>\r\n>>                                             Ciclano,\r\n>>\r\n>>\r\n>>                                             Favor nos posicionar\r\n>>                                             referente ao volume de\r\n>>                                             XYZ ,  pois o mesmo nos\r\n>>                                             cobra retorno COM URGÊNCIA.\r\n>>\r\n>>\r\n>>\r\n>>                                             Em 30/3/2017 08:24, Fulano\r\n>>                                             escreveu:\r\n>>\r\n>>                                                 Bom dia,\r\n>>\r\n>>                                                 Gabriela, agradeço o\r\n>>                                                 retorno.\r\n>>\r\n>>                                                 Ciclano, assim que\r\n>>                                                 possível nos\r\n>>                                                 posicionar frente ao\r\n>>                                                 envio do volume de XYZ.\r\n>>\r\n>>                                                 Obrigada.\r\n>>\r\n>>                                                 att,\r\n>>\r\n>>                                                 *Reinaldo Coelho *\r\n>>                                                 *Meu cargo atual*\r\n>>\r\n>>                                                 *Fone:(18) 2103-4777\r\n>>                                                 / Ramal: 725 **\r\n>>                                                 *Email:mary.anne@EmpresaX.com.br*\r\n>>\r\n>>                                                 *Acesse nosso\r\n>>                                                 site:www.EmpresaX.com.br*\r\n>>\r\n>>\r\n>>                                                 *\r\n>>                                                 Em 29/03/2017 10:35,\r\n>>                                                 Gabriela Xavier escreveu:\r\n>>\r\n>>                                                     Bom dia !\r\n>>\r\n>>                                                     Troca confirmada\r\n>>                                                     , os volumes de\r\n>>                                                     XYZ serão\r\n>>                                                     enviados hoje\r\n>>                                                     através dos RRIs\r\n>>                                                     35468888 /\r\n>>                                                     31755555 , devido\r\n>>                                                     a fiscalização.\r\n>>\r\n>>                                                     Gentileza\r\n>>                                                     acompanhar\r\n>>                                                     desembarque dos\r\n>>                                                     mesmos,  e nos\r\n>>                                                     enviar os nossos\r\n>>                                                     com urgência...\r\n>>\r\n>>\r\n>>\r\n>>\r\n>>                                                     Bueno ,\r\n>>\r\n>>                                                     Favor associar a\r\n>>                                                     devida viagem em\r\n>>                                                     sistema do SSAAS\r\n>>                                                     abaixo , hoje.\r\n>>\r\n>>\r\n>>\r\n>>\r\n>>\r\n>>\r\n>>\r\n>>\r\n>>\r\n>>                                                     -- \r\n>>\r\n>>                                                     Em 29/3/2017\r\n>>                                                     08:21, Fulano\r\n>>                                                     escreveu:\r\n>>\r\n>>                                                         Bom dia,\r\n>>\r\n>>                                                         Ok, por\r\n>>                                                         gentileza,\r\n>>                                                         assim que\r\n>>                                                         tiver\r\n>>                                                         informaçoes\r\n>>                                                         referente a\r\n>>                                                         este volume\r\n>>                                                         comunique por\r\n>>                                                         favor, para\r\n>>                                                         que a\r\n>>                                                         destroca seja\r\n>>                                                         efetuada o\r\n>>                                                         mais breve\r\n>>                                                         possivel.\r\n>>\r\n>>                                                         *Reinaldo Coelho *\r\n>>                                                         *Auxiliar\r\n>>                                                         Manutenção*\r\n>>\r\n>>                                                         *Fone:(18)\r\n>>                                                         2103-4777 /\r\n>>                                                         Ramal: 725 **\r\n>>                                                         *Email:mary.anne@EmpresaX.com.br*\r\n>>\r\n>>                                                         *Acesse nosso\r\n>>                                                         site:www.EmpresaX.com.br*\r\n>>\r\n>>\r\n>>                                                         *\r\n>>                                                         Em 28/03/2017\r\n>>                                                         17:50,\r\n>>                                                         Ciclano Ramos\r\n>>                                                         Conceição\r\n>>                                                         escreveu:\r\n>>\r\n>>                                                             ok\r\n>>\r\n>>                                                             já\r\n>>                                                             estamos\r\n>>                                                             verificando.\r\n>>\r\n>>\r\n>>                                                             -- \r\n>>                                                             *Ciclano\r\n>>                                                             Ramos\r\n>>                                                              Conceição*\r\n>>                                                             * Pendencia\r\n>>                                                             Fiscal*\r\n>>\r\n>>                                                             *Fone:(12)1111-6333*\r\n>>\r\n>>                                                             *Email:xyz.pendencias1@EmpresaX.com.br*\r\n>>\r\n>>                                                             *Acesse\r\n>>                                                             nosso\r\n>>                                                             site:www.EmpresaX.com.br*\r\n>>                                                             & amp;\r\n>>                                                             amp; lt; /p>\r\n>>\r\n>>                                                             *-----\r\n>>                                                             Original\r\n>>                                                             Message ----*\r\n>>                                                             *From:*\r\n>>                                                             mary.anne@EmpresaX.com.br\r\n>>                                                             *To:*\r\n>>                                                             \"Roque\r\n>>                                                             Neto\"\r\n>>                                                             (xyz.pendencias1@EmpresaX.com.br),\r\n>>                                                             \"Gabriela\r\n>>                                                             Xavier\"\r\n>>                                                             (XYZ.pendencia04@EmpresaX.com.br)\r\n>>                                                             *Cc:*\r\n>>                                                             \"Logística\r\n>>                                                             | Grupo\r\n>>                                                             Xamego\"\r\n>>                                                             (logistica@Xamego.com.br)\r\n>>                                                             *Date:*\r\n>>                                                             Tue, 28\r\n>>                                                             Mar 2017\r\n>>                                                             17:36:24\r\n>>                                                             -0300\r\n>>                                                             *Subject:*\r\n>>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tBLA BLÁ BLA XYZ/ XYZ / \r\n>>\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTROCA DE PACOTES origem ABC Destino \r\n>>\r\n>>                                                                 Boa\r\n>>                                                                 tarde\r\n>>                                                                 colegas,\r\n>>\r\n>>                                                                 Os\r\n>>                                                                 conhecimentos\r\n>>                                                                 citados\r\n>>                                                                 constam\r\n>>                                                                 em\r\n>>                                                                 entrega,\r\n>>                                                                 porem\r\n>>                                                                 houve\r\n>>                                                                 troca\r\n>>                                                                 de\r\n>>                                                                 etiquetagem\r\n>>                                                                 em\r\n>>                                                                 XYZ,\r\n>>                                                                 desta\r\n>>                                                                 forma,\r\n>>                                                                 peço\r\n>>                                                                 a\r\n>>                                                                 atenção\r\n>>                                                                 para\r\n>>                                                                 que\r\n>>                                                                 possamos\r\n>>                                                                 destrocar\r\n>>                                                                 o\r\n>>                                                                 mais\r\n>>                                                                 breve\r\n>>                                                                 possível\r\n>>\r\n>>                                                                 XYZ\r\n>>                                                                 322433,\r\n>>                                                                 CLIENTE\r\n>>                                                                 ME DE\r\n>>                                                                 S\r\n>>                                                                 CASTRO\r\n>>                                                                 (XYZ), \r\n>>                                                                 trocado\r\n>>                                                                 com o\r\n>>                                                                 AWB\r\n>>                                                                 383555,\r\n>>                                                                 CLIENTE\r\n>>                                                                 XE\r\n>>                                                                 MENTES(XYZ)\r\n>>\r\n>>                                                                 (O\r\n>>                                                                 cliente\r\n>>                                                                 XE\r\n>>                                                                 MENTES,\r\n>>                                                                 conforme\r\n>>                                                                 informaçoes,\r\n>>                                                                 devolveu\r\n>>                                                                 a\r\n>>                                                                 mercadoria\r\n>>                                                                 no\r\n>>                                                                 ato\r\n>>                                                                 da\r\n>>                                                                 entrega)\r\n>>\r\n>>                                                                 *Gabriela*\r\n>>                                                                 por\r\n>>                                                                 gentileza,\r\n>>                                                                 verificar\r\n>>                                                                 informação\r\n>>                                                                 de\r\n>>                                                                 devolução\r\n>>                                                                 para\r\n>>                                                                 que\r\n>>                                                                 se\r\n>>                                                                 possa\r\n>>                                                                 enviar\r\n>>                                                                 o\r\n>>                                                                 volume\r\n>>                                                                 para\r\n>>                                                                 XYZ,\r\n>>                                                                 por\r\n>>                                                                 gentileza.\r\n>>\r\n>>                                                                 *Anislei,*\r\n>>                                                                 não\r\n>>                                                                 temos\r\n>>                                                                 informaçoes\r\n>>                                                                 de\r\n>>                                                                 que o\r\n>>                                                                 cliente\r\n>>                                                                 de\r\n>>                                                                 XYZ,\r\n>>                                                                 ja\r\n>>                                                                 verificou\r\n>>                                                                 o\r\n>>                                                                 erro,\r\n>>                                                                 desta\r\n>>                                                                 forma,\r\n>>                                                                 peço,\r\n>>                                                                 entrar\r\n>>                                                                 em\r\n>>                                                                 contato\r\n>>                                                                 com a\r\n>>                                                                 tripulação\r\n>>                                                                 para\r\n>>                                                                 que a\r\n>>                                                                 entrega\r\n>>                                                                 não\r\n>>                                                                 seja\r\n>>                                                                 finalizada,\r\n>>                                                                 e\r\n>>                                                                 encaminhar\r\n>>                                                                 o\r\n>>                                                                 volume\r\n>>                                                                 para XYZ\r\n>>\r\n>>                                                                 Fico\r\n>>                                                                 no\r\n>>                                                                 aguardo,\r\n>>                                                                 pois\r\n>>                                                                 trata-se\r\n>>                                                                 de um\r\n>>                                                                 cliente\r\n>>                                                                 monitorado\r\n>>\r\n>>                                                                 *Valéria\r\n>>                                                                 Coelho *\r\n>>                                                                 *Auxiliar\r\n>>                                                                 Manutenção*\r\n>>\r\n>>\r\n>>                                                                 *Fone:(11)\r\n>>                                                                 2100-4777\r\n>>                                                                 /\r\n>\r\n\r\n";
            Assert.AreEqual(expected, result);
            Assert.IsTrue(string.IsNullOrWhiteSpace(message.BodyHtml.Text));
        }

        [Test(Description = "")]
        public void MustParseEmlContainingOnlyHeaders()
        {
            var message = Parser.ParseMessageFromFile(_baseDir + "\\resource\\only_header.eml");
            Assert.AreEqual("sender@host.com.br", message.From.Email);
            Assert.AreEqual("59a459219e757_52803fc2847231301918b@a4-winter6.mail", message.MessageId);
            Assert.AreEqual("I'm put all my text message on subject, then no has body in this e-mail. second line exists too.", message.Subject);
            Assert.IsTrue(string.IsNullOrWhiteSpace(message.BodyText.Text));
            Assert.IsTrue(string.IsNullOrWhiteSpace(message.BodyHtml.Text));
            Assert.AreEqual(0, message.Attachments.Count);
        }

        [Test(Description = "")]
        public void MustParseEmlContainingOnlyHeaders2()
        {
            var message = Parser.ParseMessageFromFile(_baseDir + "\\resource\\only_header_2.eml");
            Assert.AreEqual("parceiro@abidos.com.br", message.From.Email);
            Assert.AreEqual("d38c1c1f-abdc-483e-b8b5-cb95c65c2eeb@CY1NAM02FT029.eop-nam02.prod.protection.outlook.com", message.MessageId);
            Assert.AreEqual("Conclua sua pos em 6 meses!!!", message.Subject);
            Assert.IsTrue(string.IsNullOrWhiteSpace(message.BodyText.Text));
            Assert.IsTrue(string.IsNullOrWhiteSpace(message.BodyHtml.Text));
            Assert.AreEqual(0, message.Attachments.Count);
            Assert.AreEqual(0, message.LeafMimeParts.Count);
        }

        [Test(Description = "")]
        public void MustParse8BitEmlWithSpecialCharInHtmlBody()
        {
            var message = Parser.ParseMessageFromFile(_baseDir + "\\resource\\content-transfer-encode-8bit-html-special-char.eml");
            Assert.AreEqual("fromemail@domain.com", message.From.Email);
            Assert.AreEqual("3a8c760555b716f3834fef3a2b05f160@deskserver.ms", message.MessageId);
            Assert.AreEqual("CLIENT - BRASIL Status: OPEN / RESOLVED #0917-000622", message.Subject);
            Assert.IsFalse(string.IsNullOrWhiteSpace(message.BodyText.Text));
            Assert.AreEqual("Para visualizar a mensagem, por favor, use um cliente de e-mail compatÃ\u0083Â­vel/configurado para ver mensagens HTML!\r\n\r\n", message.BodyText.Text);
            Assert.IsFalse(string.IsNullOrWhiteSpace(message.BodyHtml.Text));
            Assert.AreEqual("\r\n  <!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\"> \r\n  <html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"pt\" lang=\"pt\"> \r\n   <head> \r\n    <title></title>\r\n    <meta name=\"author\" content=\"suporte\" />\r\n    <meta http-equiv=\"Content-Type\" content=\"text/html; charset =iso-8859-1\" /> \r\n    <style>\r\n    .txt_padrao  {font-family:Arial;font-size:12px}\r\n    #bold    {font-weight:bold;}\r\n    </style>\r\n  </head> \r\n  <body leftmargin=\"5\" topmargin=\"5\"  marginheight=\"0\" smarginwidth=\"0\">\r\n<br />\r\n Qualquer dÃºvida estou a disposiÃ§Ã£o.<br />\r\n<br />\r\n Atenciosamente,<br />\r\n<br />\r\n<br />\r\n <br />\r\n     <br />\r\n         <br />\r\n             <br />\r\n                <br />\r\n  <br />\r\n <br />\r\n<br />\r\n             <br />\r\n  <br />\r\n                  Ronald Santander<br />\r\n _________________________<br />\r\n<br />\r\n                 CLIENT<br />\r\n Consultor de Viagens <br />\r\n Tel.: +   (55 11) 2222-4444 <br />\r\n Tel.: +   (55 11) 3333-6666<br />\r\n                <br />\r\n                 <br />\r\n<br />\r\n Outros telefones <br />\r\n<br />\r\n             <br />\r\n         <br />\r\n     <br />\r\n <br />\r\n<br />\r\n  ATENÃ\u0087Ã\u0083O! <br />\r\n<br />\r\n<br />\r\n<br />\r\n Prezado cliente, Seguindo a nova resoluÃ§Ã£o do Regulador XXXXX, homologada em Abril/2016, e que impÃµe a emissÃ£o de certificado de seguro viagem individuais, tanto para viagem domÃ©stica quanto internacional, as bandeiras American Express, Mastercard e Visa estÃ£o migrando o processo de emissÃ£o do certificado do seguro viagem, benefÃ­cio incluso em suas soluÃ§Ãµes corporativas de pagamentos se utilizado pela sua empresa.<br />\r\n<br />\r\n<br />\r\n Todos os novos procedimentos de emissÃ£o do certificado do seguro viagem foram comunicados e disponibilizados aos gestores de viagens da sua empresa. Caso nÃ£o tenha conhecimento do novo procedimento, se faz necessÃ¡rio verificar com o gestor responsÃ¡vel de sua empresa, pois a emissÃ£o do certificado Ã© de total responsabilidade do viajante e requer acesso a ferramenta de emissÃ£o a cada viagem, por meio de login, senha e dados pessoais.<br />\r\n<br />\r\n<br />\r\n<br />\r\n  INFORMAÃ\u0087Ã\u0095ES IMPORTANTES <br />\r\n<br />\r\n<br />\r\n <br />\r\n     A garantia da reserva, do assento e da tarifa sÃ£o a emissÃ£o do bilhete; <br />\r\n     Tarifas sujeitas a alteraÃ§Ã£o sem prÃ©vio aviso. <br />\r\n     AtenÃ§Ã£o ao prazo de emissÃ£o das reservas; <br />\r\n     Para alteraÃ§Ãµes, cancelamentos ou reembolsos hÃ¡ incidÃªncia de multas e/ou diferenÃ§as tarifÃ¡rias conforme regra do bilhete; <br />\r\n      Multa por Churning:  Segundo a polÃ­tica de reservas, poderÃ¡ haver cobranÃ§a de multa em caso de solicitaÃ§Ã£o/realizaÃ§Ã£o de sucessivas operaÃ§Ãµes para o mesmo passageiro/ cia aÃ©rea/trecho. Esta cobranÃ§a,  multa por  Churning - Excessive or constant book/cancel activity  , ocorre quando a cia aÃ©rea detecta o mesmo trecho aÃ©reo ou parte dele solicitado a partir da segunda vez em datas idÃªnticas ou prÃ³ximas (atÃ© 5 dias antes ou depois para ida e/ou volta). As multas recebidas serÃ£o repassadas Ã  empresa. <br />\r\n <br />\r\n<br />\r\n  VIAGENS INTERNACIONAIS PARA BRASILEIROS <br />\r\n<br />\r\n<br />\r\n <br />\r\n     Chegar no aeroporto com 3 horas de antecedÃªncia para o embarque; <br />\r\n     Apresentar passaporte com validade mÃ­nima de 6 meses; <br />\r\n     Para paÃ­ses que necessitam de visto, o mesmo deve estar vÃ¡lido no momento do embarque; <br />\r\n     Para paÃ­ses que exigem vacina contra febre amarela, apresentar comprovante internacional com perÃ­odo de incubaÃ§Ã£o de 10 dias; <br />\r\n     Para maiores informaÃ§Ãµes sobre vacinas necessÃ¡rias ou indicadas para seu destino visite o site:  http://www.anvisa.gov.br/viajante/ ; <br />\r\n     Para viagens internacionais Ã© necessÃ¡rio informar o  Nome completo do passageiro (idÃªntico ao Passaporte), Data de nascimento, NÃºmero do passaporte, PaÃ­s de emissÃ£o do passaporte, Validade, Nacionalidade, PaÃ­s de residÃªncia, PaÃ­s de destino, EndereÃ§o no destino, Cidade, Estado, Cep. EndereÃ§o residencial, Cidade, Estado e Cep.  Para inclusÃ£o das informaÃ§Ãµes de seguranÃ§a na reserva antes da emissÃ£o do bilhete; <br />\r\n <br />\r\n<br />\r\n  VIAGENS NACIONAIS <br />\r\n<br />\r\n<br />\r\n <br />\r\n     Chegar no aeroporto com 2 horas de antecedÃªncia para o embarque; <br />\r\n     ApresentaÃ§Ã£o obrigatÃ³ria de um documento de identificaÃ§Ã£o original com foto e atual para embarque; <br />\r\n     Favor sempre informar o nÃºmero de identidade, cartÃ£o de milhas e preferÃªncia de assento do passageiro no momento da reserva;</td>\r\n      </tr>\r\n    <tr><td colspan=\"2\" ><hr></td></tr><tr><td height=\"35\" align=\"left\"  colspan=\"2\" ><table><tr><td><img src=\"./ico_visto.gif\" width=\"25\" height=\"25\" border=\"0\" alt=\"\"></td><td class=\"txt_padrao\" id=\"bold\" >Dados da AÃ§Ã£o</td></tr></table></td></tr>\r\n      <tr>\r\n        <td class=\"txt_padrao\" align=\"right\" width=\"150\" >Forma de atendimento:</td>\r\n        <td class=\"txt_padrao\" width=\"590\" >&nbsp;DESK MANAGER</td>\r\n      </tr>\r\n    \r\n      <tr>\r\n        <td class=\"txt_padrao\" align=\"right\">Causa:</td>\r\n        <td class=\"txt_padrao\">&nbsp;ATUALIZAÃ\u0087Ã\u0083O</td>\r\n      </tr>\r\n      <tr><td colspan=\"2\" ><hr></td></tr>\r\n      <tr>\r\n        <td width=\"35\" height=\"35\" align=\"right\"><img src=\"./ico_visto.gif\" width=\"25\" height=\"25\" border=\"0\" alt=\"\"></td>\r\n        <td width=\"740\" class=\"txt_padrao\" id=\"bold\"> DescriÃ§Ã£o da AÃ§Ã£o:</td>\r\n      </tr>\r\n      </tr>\r\n        <td>&nbsp;</td>\r\n        <td class=\"txt_padrao\">Bom dia \r\n<br>\r\n<br>cadastrado atualizado cliente control xpto certifications<p>Atenciosamente,<br />DONALD L. THRUMP<br />donald.thrump@domain.com<br />Telefone: (11)5555-2222 <br /><img src=\"./159282496_logo_novo2.gif\" border=\"0\"></td>\r\n      </tr>\r\n    \r\n    <tr><td colspan=\"2\"><hr></td></tr>\r\n    \r\n      </tr>\r\n        <td>&nbsp;</td>\r\n        <td class=\"txt_padrao\">\r\n        Para visualizar o conteÃºdo da AÃ§Ã£o, por favor acessar:<br>\r\n        <a href=\"https://domain.deskserver.ms/?LoginPortal\">https://domain.deskserver.ms/?LoginPortal</a>\r\n        </td>\r\n      </tr>\r\n    \r\n    <tr>\r\n      <td height=\"35\" align=\"right\"><img src=\"./ico_alert.gif\" width=\"25\" height=\"25\" border=\"0\" alt=\"\"></td>\r\n      <td class=\"txt_padrao\" id=\"bold\"> Este e-mail Ã© gerado automaticamente.</td>\r\n    </tr>\r\n\r\n    <tr><td colspan=\"2\" ><hr></td></tr>\r\n    </table>\r\n\r\n  </body> \r\n  </html>\r\n  \r\n\r\n\r\n", message.BodyHtml.Text);
            Assert.AreEqual(0, message.Attachments.Count);
            Assert.AreEqual(2, message.LeafMimeParts.Count);
        }
    }
}
